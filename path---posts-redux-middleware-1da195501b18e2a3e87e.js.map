{"version":3,"sources":["webpack:///path---posts-redux-middleware-1da195501b18e2a3e87e.js","webpack:///./.cache/json/posts-redux-middleware.json"],"names":["webpackJsonp","476","module","exports","data","site","siteMetadata","title","author","markdownRemark","id","html","fields","slug","frontmatter","date","tags","pathContext"],"mappings":"AAAAA,cAAc,iBAERC,IACA,SAAUC,EAAQC,GCHxBD,EAAAC,SAAkBC,MAAQC,MAAQC,cAAgBC,MAAA,OAAAC,OAAA,eAAsCC,gBAAmBC,GAAA,wIAAAC,KAAA,mngBAA2ihBC,QAAkSC,KAAA,4BAAkCC,aAAgBP,MAAA,qBAAAQ,KAAA,mBAAAC,MAAA,oBAAkFC,aAAgBJ,KAAA","file":"path---posts-redux-middleware-1da195501b18e2a3e87e.js","sourcesContent":["webpackJsonp([257634389667650],{\n\n/***/ 476:\n/***/ (function(module, exports) {\n\n\tmodule.exports = {\"data\":{\"site\":{\"siteMetadata\":{\"title\":\"前端小誌\",\"author\":\"Ernie Yang\"}},\"markdownRemark\":{\"id\":\"/Users/ernieyang09/Desktop/workspace/gatsby-blog/src/pages/posts/2017/08/0814--redux-middleware.md absPath of file >>> MarkdownRemark\",\"html\":\"<snippet>\\n學習SPA一陣子了，有權限的系統還是蠻麻煩的。這次考慮的是Oauth與REST api使用token的問題。\\n</snippet>\\n<p>原本一開始的想法是在router執行action的時候(LOCATION_CHANGE)，做一個Middleware，執行權限的判斷，但想想有一些頁面是不需要判斷的(Ex:忘記密碼、註冊)\\n最後決定使用HOC的方式只在特定的router location附加此功能。</p>\\n<p>不過這些都是對於Oauth還不熟的時候，時間急迫下直接動工寫的，寫這篇文章的時候特別去找了相關文章看看別人是怎麼做的。<a href=\\\"https://stackoverflow.com/questions/34977898/need-oauth-2-client-implementation-for-react-router\\\">這篇實作</a>就跟我的想法蠻類似的。</p>\\n<p>目前手上開發的是Oauth2.0 implicit flow，在毎一次呼叫api的時候都須要在header帶上token，這時候有人告訴我說呼叫api error要跳錯，但是token過期與驗證失敗要導到login畫面去。</p>\\n<p>最直覺的做法就是每個api的fetch裡面都加入error handler</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-js\\\"><code class=\\\"language-js\\\"><span class=\\\"token function\\\">fetch</span><span class=\\\"token punctuation\\\">(</span>api<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">then</span><span class=\\\"token punctuation\\\">(</span> <span class=\\\"token punctuation\\\">(</span>response<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token operator\\\">...</span>\\n  <span class=\\\"token keyword\\\">if</span> <span class=\\\"token punctuation\\\">(</span>resoponse<span class=\\\"token punctuation\\\">.</span>status <span class=\\\"token operator\\\">!==</span> <span class=\\\"token operator\\\">...</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n    <span class=\\\"token comment\\\">// error handler here</span>\\n    <span class=\\\"token comment\\\">// dispatch delete token</span>\\n  <span class=\\\"token punctuation\\\">}</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span></code></pre>\\n      </div>\\n<p>但是最直覺的做法怎樣想都是一個很蠢的寫法XD，更好的寫法應該會想到放到Middleware裡面，對api制定統一格式。強者我同事馬上教我寫fetch middleware。</p>\\n<h4>redux middleware</h4>\\n<p>有時候我們會想在dispatch action -> reducer中間做一些客制的\\\"動作\\\"，middleware可以很好的幫我們處理這件事情。\\nmiddleware使用的是組合(compose)的方式，所以執行會有順序性。</p>\\n<p>\\n  <span\\n    class=\\\"gatsby-resp-image-wrapper\\\"\\n    style=\\\"position: relative; display: block; ; max-width: 590px; margin-left: auto; margin-right: auto;\\\"\\n  >\\n    <span\\n      class=\\\"gatsby-resp-image-background-image\\\"\\n      style=\\\"padding-bottom: 27.625%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAAAyElEQVQY051Q7Q6DIAzk/V/Sj6Cb4kAF1AzdrUVJ2PZvDZeG6+X6IfB60fvFcRwReeR8rk01hsgJDhaHfcdOYK7ve9R1jaIosCxL5LgWQvholLKY5xnjOGLdNmhtME3n33kPax2UUmjbGzoyts6B9VprzNbCmDFynrTMeb9A8ARSSqzrho1MLQmlbKJAqQGyaeCcJyNLjSbc7x3KssTweERTbmpogKqqYjOR7pHuxflJ6+zX2rxaOkO4+PC18ulxZvF9g3+Qe7wBWsnUY2MfGRYAAAAASUVORK5CYII='); background-size: cover; display: block;\\\"\\n    >\\n      <img\\n        class=\\\"gatsby-resp-image-image\\\"\\n        style=\\\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\\\"\\n        alt=\\\"middleware01\\\"\\n        title=\\\"\\\"\\n        src=\\\"/static/redux-middleware01-6ba72701eb332e5645bb08fedadfbcbf-a408b.png\\\"\\n        srcset=\\\"/static/redux-middleware01-6ba72701eb332e5645bb08fedadfbcbf-4eabf.png 148w,\\n/static/redux-middleware01-6ba72701eb332e5645bb08fedadfbcbf-5a375.png 295w,\\n/static/redux-middleware01-6ba72701eb332e5645bb08fedadfbcbf-a408b.png 590w,\\n/static/redux-middleware01-6ba72701eb332e5645bb08fedadfbcbf-4cbbd.png 800w\\\"\\n        sizes=\\\"(max-width: 590px) 100vw, 590px\\\"\\n      />\\n    </span>\\n  </span>\\n  </p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-js\\\"><code class=\\\"language-js\\\"><span class=\\\"token function\\\">applyMiddleware</span><span class=\\\"token punctuation\\\">(</span>\\n  middleware1<span class=\\\"token punctuation\\\">,</span>\\n  middleware2<span class=\\\"token punctuation\\\">,</span>\\n  middleware3<span class=\\\"token punctuation\\\">,</span> <span class=\\\"token comment\\\">// &lt;--這行會先被執行</span>\\n<span class=\\\"token punctuation\\\">)</span></code></pre>\\n      </div>\\n<p>然後middleware的寫法屬於Monkeypatching的curry，寫起來大概長這樣</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-js\\\"><code class=\\\"language-js\\\"><span class=\\\"token keyword\\\">const</span> <span class=\\\"token function-variable function\\\">middleware</span> <span class=\\\"token operator\\\">=</span> store <span class=\\\"token operator\\\">=></span> next <span class=\\\"token operator\\\">=></span> action <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token keyword\\\">if</span> <span class=\\\"token punctuation\\\">(</span>action<span class=\\\"token punctuation\\\">.</span>whatever <span class=\\\"token operator\\\">===</span> distinct value<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n    custom event\\n  <span class=\\\"token punctuation\\\">}</span> <span class=\\\"token keyword\\\">else</span> <span class=\\\"token punctuation\\\">{</span>\\n    <span class=\\\"token keyword\\\">return</span> <span class=\\\"token function\\\">next</span><span class=\\\"token punctuation\\\">(</span>action<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token punctuation\\\">}</span>\\n<span class=\\\"token punctuation\\\">}</span></code></pre>\\n      </div>\\n<p>需要注意store.dispatch與next的效果是不一樣的。\\n\\n  <span\\n    class=\\\"gatsby-resp-image-wrapper\\\"\\n    style=\\\"position: relative; display: block; ; max-width: 590px; margin-left: auto; margin-right: auto;\\\"\\n  >\\n    <span\\n      class=\\\"gatsby-resp-image-background-image\\\"\\n      style=\\\"padding-bottom: 40.375%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABG0lEQVQoz3VSi46EIAz0///zdl0fCAKCovZmuovxLtkmpGiH6UyhEcR5nlKjlCI5Z0kpybquV435G27btgvT3EEsxhhlWRbNzjnN96bMtV6ztVb3jIuQasw4igXJBEDf9xJC0FUVMKhqJA6YaZr+4Ki6Ieg4DlWXQdq/WnEAORwwOOC9v1QSF2KSBNKue2mtEpOQuOaaCVR4YySguGO/+FnGx4/MOMRm6qIISFaxJqnFfS9KMgyDjodOmh1dNxywbSsZoBU/I7IDsXs+xKMzx0KcGaPMXaukvcmyfObMRbU6Q3anvRk/aSXTOlaC/QD7B3K9sMmgiXVomsXNUJnetxw+TZVQbsEZUTYviPnE9/9nVXGlbIpR3O0F/AKDyG+LfrQZ6AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\\\"\\n    >\\n      <img\\n        class=\\\"gatsby-resp-image-image\\\"\\n        style=\\\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\\\"\\n        alt=\\\"middleware02\\\"\\n        title=\\\"\\\"\\n        src=\\\"/static/redux-middleware02-0a538ac8ba2864c79d4c3b12f4fed415-a408b.png\\\"\\n        srcset=\\\"/static/redux-middleware02-0a538ac8ba2864c79d4c3b12f4fed415-4eabf.png 148w,\\n/static/redux-middleware02-0a538ac8ba2864c79d4c3b12f4fed415-5a375.png 295w,\\n/static/redux-middleware02-0a538ac8ba2864c79d4c3b12f4fed415-a408b.png 590w,\\n/static/redux-middleware02-0a538ac8ba2864c79d4c3b12f4fed415-4cbbd.png 800w\\\"\\n        sizes=\\\"(max-width: 590px) 100vw, 590px\\\"\\n      />\\n    </span>\\n  </span>\\n  \\n網路上有很多好文章，可以去閱讀\\b<a href=\\\"http://redux.js.org/docs/advanced/Middleware.html\\\">這篇</a>或是<a href=\\\"https://segmentfault.com/a/1190000004485808\\\">這篇</a>。</p>\\n<h4>實作fetch middleware</h4>\\n<p>其實npm上已經有相關的套件了，像是<a href=\\\"https://github.com/fantasywind/redux-middleware-fetch\\\">redux-middleware-fetch</a>與<a href=\\\"https://github.com/jasonslyvia/redux-composable-fetch\\\">redux-composable-fetch</a></p>\\n<p>我的實作很簡單，帶給action types屬性，分別代表[success, error, loading]時候的action，剩下的我直接帶入fetch的url &#x26;&#x26; settings，應該拿到的resoponseHttpCode，還有帶入callback，方便做一般的處理\\n或是再chain promise or dispatch皆可以。另外我習慣return promise，這樣前端可以await dispatch，可以更靈活的使用。</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-js\\\"><code class=\\\"language-js\\\"><span class=\\\"token comment\\\">//\\bmiddleware</span>\\n<span class=\\\"token keyword\\\">export</span> <span class=\\\"token keyword\\\">default</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> next <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">(</span>action<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token keyword\\\">if</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token operator\\\">!</span>action<span class=\\\"token punctuation\\\">.</span>types<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n    <span class=\\\"token keyword\\\">return</span> <span class=\\\"token function\\\">next</span><span class=\\\"token punctuation\\\">(</span>action<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token punctuation\\\">}</span>\\n  <span class=\\\"token keyword\\\">const</span> <span class=\\\"token punctuation\\\">[</span>Success<span class=\\\"token punctuation\\\">,</span> Fail<span class=\\\"token punctuation\\\">,</span> Request<span class=\\\"token punctuation\\\">]</span> <span class=\\\"token operator\\\">=</span> action<span class=\\\"token punctuation\\\">.</span>types<span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token keyword\\\">const</span> options <span class=\\\"token operator\\\">=</span> action<span class=\\\"token punctuation\\\">.</span>options<span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token function\\\">next</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">{</span>\\n    type<span class=\\\"token punctuation\\\">:</span> Request<span class=\\\"token punctuation\\\">,</span>\\n  <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token keyword\\\">return</span> <span class=\\\"token keyword\\\">new</span> <span class=\\\"token class-name\\\">Promise</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">(</span>resolve<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n    <span class=\\\"token function\\\">fetch</span><span class=\\\"token punctuation\\\">(</span>options<span class=\\\"token punctuation\\\">.</span>url<span class=\\\"token punctuation\\\">,</span> options<span class=\\\"token punctuation\\\">.</span>config<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">then</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token keyword\\\">async</span> <span class=\\\"token punctuation\\\">(</span>response<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n      <span class=\\\"token keyword\\\">let</span> json<span class=\\\"token punctuation\\\">;</span>\\n      <span class=\\\"token keyword\\\">if</span> <span class=\\\"token punctuation\\\">(</span>response<span class=\\\"token punctuation\\\">.</span>status <span class=\\\"token operator\\\">!==</span> <span class=\\\"token number\\\">204</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n        json <span class=\\\"token operator\\\">=</span> <span class=\\\"token keyword\\\">await</span> response<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">json</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n      <span class=\\\"token punctuation\\\">}</span>\\n      <span class=\\\"token keyword\\\">if</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token operator\\\">!</span>options<span class=\\\"token punctuation\\\">.</span>responseCode<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">includes</span><span class=\\\"token punctuation\\\">(</span>response<span class=\\\"token punctuation\\\">.</span>status<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n        <span class=\\\"token keyword\\\">throw</span> json<span class=\\\"token punctuation\\\">;</span>\\n      <span class=\\\"token punctuation\\\">}</span>\\n      <span class=\\\"token keyword\\\">if</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token keyword\\\">typeof</span> options<span class=\\\"token punctuation\\\">.</span>onSuccess <span class=\\\"token operator\\\">===</span> <span class=\\\"token string\\\">'function'</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n        options<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">onSuccess</span><span class=\\\"token punctuation\\\">(</span>json<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n      <span class=\\\"token punctuation\\\">}</span>\\n      <span class=\\\"token function\\\">next</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">{</span>\\n        type<span class=\\\"token punctuation\\\">:</span> Success<span class=\\\"token punctuation\\\">,</span>\\n        data<span class=\\\"token punctuation\\\">:</span> json<span class=\\\"token punctuation\\\">,</span>\\n      <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n      <span class=\\\"token function\\\">resolve</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token boolean\\\">true</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n    <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">.</span><span class=\\\"token keyword\\\">catch</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">(</span>e<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n      <span class=\\\"token keyword\\\">switch</span><span class=\\\"token punctuation\\\">(</span>e<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n        <span class=\\\"token keyword\\\">case</span> <span class=\\\"token string\\\">'token失效'</span><span class=\\\"token punctuation\\\">:</span>\\n        \\b<span class=\\\"token keyword\\\">case</span> <span class=\\\"token string\\\">'api error'</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token operator\\\">...</span>\\n      <span class=\\\"token punctuation\\\">}</span>\\n      <span class=\\\"token function\\\">resolve</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token boolean\\\">false</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n      <span class=\\\"token function\\\">next</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">{</span>\\n        type<span class=\\\"token punctuation\\\">:</span> Fail<span class=\\\"token punctuation\\\">,</span>\\n        error<span class=\\\"token punctuation\\\">:</span> e<span class=\\\"token punctuation\\\">,</span>\\n      <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n    <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n\\n\\n<span class=\\\"token comment\\\">//action</span>\\n<span class=\\\"token keyword\\\">export</span> <span class=\\\"token keyword\\\">const</span> <span class=\\\"token function-variable function\\\">action</span> <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">{</span>\\n  types<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">[</span>fetchSuccess<span class=\\\"token punctuation\\\">,</span> fetchError<span class=\\\"token punctuation\\\">,</span> fetching<span class=\\\"token punctuation\\\">]</span><span class=\\\"token punctuation\\\">,</span>\\n  options<span class=\\\"token punctuation\\\">:</span> <span class=\\\"token punctuation\\\">{</span>\\n    url<span class=\\\"token punctuation\\\">:</span> apiURL<span class=\\\"token punctuation\\\">,</span>\\n    config<span class=\\\"token punctuation\\\">:</span> <span class=\\\"token punctuation\\\">{</span>\\n      method<span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">'GET'</span><span class=\\\"token punctuation\\\">,</span>\\n      <span class=\\\"token operator\\\">...</span>\\n    <span class=\\\"token punctuation\\\">}</span>\\n  <span class=\\\"token punctuation\\\">}</span>\\n\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span></code></pre>\\n      </div>\\n<p>相信大部份人學習redux要處理非同步一定都聽過redux-thunk，短短的14行code拿下了6000+的星星。</p>\\n<p>這些都算是middleware的基礎，進階的應用也有chain promise(redux saga,redux observable)或是串web socket，middleware的概念很有趣，實作起來並不能難，能做的事情卻很多，建議一定要學一下。</p>\",\"fields\":{\"slug\":\"/posts/redux-middleware/\"},\"frontmatter\":{\"title\":\"Redux Middleware應用\",\"date\":\"2017-08-14T00:04\",\"tags\":[\"react\",\"redux\"]}}},\"pathContext\":{\"slug\":\"/posts/redux-middleware/\"}}\n\n/***/ })\n\n});\n\n\n// WEBPACK FOOTER //\n// path---posts-redux-middleware-1da195501b18e2a3e87e.js","module.exports = {\"data\":{\"site\":{\"siteMetadata\":{\"title\":\"前端小誌\",\"author\":\"Ernie Yang\"}},\"markdownRemark\":{\"id\":\"/Users/ernieyang09/Desktop/workspace/gatsby-blog/src/pages/posts/2017/08/0814--redux-middleware.md absPath of file >>> MarkdownRemark\",\"html\":\"<snippet>\\n學習SPA一陣子了，有權限的系統還是蠻麻煩的。這次考慮的是Oauth與REST api使用token的問題。\\n</snippet>\\n<p>原本一開始的想法是在router執行action的時候(LOCATION_CHANGE)，做一個Middleware，執行權限的判斷，但想想有一些頁面是不需要判斷的(Ex:忘記密碼、註冊)\\n最後決定使用HOC的方式只在特定的router location附加此功能。</p>\\n<p>不過這些都是對於Oauth還不熟的時候，時間急迫下直接動工寫的，寫這篇文章的時候特別去找了相關文章看看別人是怎麼做的。<a href=\\\"https://stackoverflow.com/questions/34977898/need-oauth-2-client-implementation-for-react-router\\\">這篇實作</a>就跟我的想法蠻類似的。</p>\\n<p>目前手上開發的是Oauth2.0 implicit flow，在毎一次呼叫api的時候都須要在header帶上token，這時候有人告訴我說呼叫api error要跳錯，但是token過期與驗證失敗要導到login畫面去。</p>\\n<p>最直覺的做法就是每個api的fetch裡面都加入error handler</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-js\\\"><code class=\\\"language-js\\\"><span class=\\\"token function\\\">fetch</span><span class=\\\"token punctuation\\\">(</span>api<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">then</span><span class=\\\"token punctuation\\\">(</span> <span class=\\\"token punctuation\\\">(</span>response<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token operator\\\">...</span>\\n  <span class=\\\"token keyword\\\">if</span> <span class=\\\"token punctuation\\\">(</span>resoponse<span class=\\\"token punctuation\\\">.</span>status <span class=\\\"token operator\\\">!==</span> <span class=\\\"token operator\\\">...</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n    <span class=\\\"token comment\\\">// error handler here</span>\\n    <span class=\\\"token comment\\\">// dispatch delete token</span>\\n  <span class=\\\"token punctuation\\\">}</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span></code></pre>\\n      </div>\\n<p>但是最直覺的做法怎樣想都是一個很蠢的寫法XD，更好的寫法應該會想到放到Middleware裡面，對api制定統一格式。強者我同事馬上教我寫fetch middleware。</p>\\n<h4>redux middleware</h4>\\n<p>有時候我們會想在dispatch action -> reducer中間做一些客制的\\\"動作\\\"，middleware可以很好的幫我們處理這件事情。\\nmiddleware使用的是組合(compose)的方式，所以執行會有順序性。</p>\\n<p>\\n  <span\\n    class=\\\"gatsby-resp-image-wrapper\\\"\\n    style=\\\"position: relative; display: block; ; max-width: 590px; margin-left: auto; margin-right: auto;\\\"\\n  >\\n    <span\\n      class=\\\"gatsby-resp-image-background-image\\\"\\n      style=\\\"padding-bottom: 27.625%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAAAyElEQVQY051Q7Q6DIAzk/V/Sj6Cb4kAF1AzdrUVJ2PZvDZeG6+X6IfB60fvFcRwReeR8rk01hsgJDhaHfcdOYK7ve9R1jaIosCxL5LgWQvholLKY5xnjOGLdNmhtME3n33kPax2UUmjbGzoyts6B9VprzNbCmDFynrTMeb9A8ARSSqzrho1MLQmlbKJAqQGyaeCcJyNLjSbc7x3KssTweERTbmpogKqqYjOR7pHuxflJ6+zX2rxaOkO4+PC18ulxZvF9g3+Qe7wBWsnUY2MfGRYAAAAASUVORK5CYII='); background-size: cover; display: block;\\\"\\n    >\\n      <img\\n        class=\\\"gatsby-resp-image-image\\\"\\n        style=\\\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\\\"\\n        alt=\\\"middleware01\\\"\\n        title=\\\"\\\"\\n        src=\\\"/static/redux-middleware01-6ba72701eb332e5645bb08fedadfbcbf-a408b.png\\\"\\n        srcset=\\\"/static/redux-middleware01-6ba72701eb332e5645bb08fedadfbcbf-4eabf.png 148w,\\n/static/redux-middleware01-6ba72701eb332e5645bb08fedadfbcbf-5a375.png 295w,\\n/static/redux-middleware01-6ba72701eb332e5645bb08fedadfbcbf-a408b.png 590w,\\n/static/redux-middleware01-6ba72701eb332e5645bb08fedadfbcbf-4cbbd.png 800w\\\"\\n        sizes=\\\"(max-width: 590px) 100vw, 590px\\\"\\n      />\\n    </span>\\n  </span>\\n  </p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-js\\\"><code class=\\\"language-js\\\"><span class=\\\"token function\\\">applyMiddleware</span><span class=\\\"token punctuation\\\">(</span>\\n  middleware1<span class=\\\"token punctuation\\\">,</span>\\n  middleware2<span class=\\\"token punctuation\\\">,</span>\\n  middleware3<span class=\\\"token punctuation\\\">,</span> <span class=\\\"token comment\\\">// &lt;--這行會先被執行</span>\\n<span class=\\\"token punctuation\\\">)</span></code></pre>\\n      </div>\\n<p>然後middleware的寫法屬於Monkeypatching的curry，寫起來大概長這樣</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-js\\\"><code class=\\\"language-js\\\"><span class=\\\"token keyword\\\">const</span> <span class=\\\"token function-variable function\\\">middleware</span> <span class=\\\"token operator\\\">=</span> store <span class=\\\"token operator\\\">=></span> next <span class=\\\"token operator\\\">=></span> action <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token keyword\\\">if</span> <span class=\\\"token punctuation\\\">(</span>action<span class=\\\"token punctuation\\\">.</span>whatever <span class=\\\"token operator\\\">===</span> distinct value<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n    custom event\\n  <span class=\\\"token punctuation\\\">}</span> <span class=\\\"token keyword\\\">else</span> <span class=\\\"token punctuation\\\">{</span>\\n    <span class=\\\"token keyword\\\">return</span> <span class=\\\"token function\\\">next</span><span class=\\\"token punctuation\\\">(</span>action<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token punctuation\\\">}</span>\\n<span class=\\\"token punctuation\\\">}</span></code></pre>\\n      </div>\\n<p>需要注意store.dispatch與next的效果是不一樣的。\\n\\n  <span\\n    class=\\\"gatsby-resp-image-wrapper\\\"\\n    style=\\\"position: relative; display: block; ; max-width: 590px; margin-left: auto; margin-right: auto;\\\"\\n  >\\n    <span\\n      class=\\\"gatsby-resp-image-background-image\\\"\\n      style=\\\"padding-bottom: 40.375%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABG0lEQVQoz3VSi46EIAz0///zdl0fCAKCovZmuovxLtkmpGiH6UyhEcR5nlKjlCI5Z0kpybquV435G27btgvT3EEsxhhlWRbNzjnN96bMtV6ztVb3jIuQasw4igXJBEDf9xJC0FUVMKhqJA6YaZr+4Ki6Ieg4DlWXQdq/WnEAORwwOOC9v1QSF2KSBNKue2mtEpOQuOaaCVR4YySguGO/+FnGx4/MOMRm6qIISFaxJqnFfS9KMgyDjodOmh1dNxywbSsZoBU/I7IDsXs+xKMzx0KcGaPMXaukvcmyfObMRbU6Q3anvRk/aSXTOlaC/QD7B3K9sMmgiXVomsXNUJnetxw+TZVQbsEZUTYviPnE9/9nVXGlbIpR3O0F/AKDyG+LfrQZ6AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\\\"\\n    >\\n      <img\\n        class=\\\"gatsby-resp-image-image\\\"\\n        style=\\\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\\\"\\n        alt=\\\"middleware02\\\"\\n        title=\\\"\\\"\\n        src=\\\"/static/redux-middleware02-0a538ac8ba2864c79d4c3b12f4fed415-a408b.png\\\"\\n        srcset=\\\"/static/redux-middleware02-0a538ac8ba2864c79d4c3b12f4fed415-4eabf.png 148w,\\n/static/redux-middleware02-0a538ac8ba2864c79d4c3b12f4fed415-5a375.png 295w,\\n/static/redux-middleware02-0a538ac8ba2864c79d4c3b12f4fed415-a408b.png 590w,\\n/static/redux-middleware02-0a538ac8ba2864c79d4c3b12f4fed415-4cbbd.png 800w\\\"\\n        sizes=\\\"(max-width: 590px) 100vw, 590px\\\"\\n      />\\n    </span>\\n  </span>\\n  \\n網路上有很多好文章，可以去閱讀\\b<a href=\\\"http://redux.js.org/docs/advanced/Middleware.html\\\">這篇</a>或是<a href=\\\"https://segmentfault.com/a/1190000004485808\\\">這篇</a>。</p>\\n<h4>實作fetch middleware</h4>\\n<p>其實npm上已經有相關的套件了，像是<a href=\\\"https://github.com/fantasywind/redux-middleware-fetch\\\">redux-middleware-fetch</a>與<a href=\\\"https://github.com/jasonslyvia/redux-composable-fetch\\\">redux-composable-fetch</a></p>\\n<p>我的實作很簡單，帶給action types屬性，分別代表[success, error, loading]時候的action，剩下的我直接帶入fetch的url &#x26;&#x26; settings，應該拿到的resoponseHttpCode，還有帶入callback，方便做一般的處理\\n或是再chain promise or dispatch皆可以。另外我習慣return promise，這樣前端可以await dispatch，可以更靈活的使用。</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-js\\\"><code class=\\\"language-js\\\"><span class=\\\"token comment\\\">//\\bmiddleware</span>\\n<span class=\\\"token keyword\\\">export</span> <span class=\\\"token keyword\\\">default</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> next <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">(</span>action<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token keyword\\\">if</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token operator\\\">!</span>action<span class=\\\"token punctuation\\\">.</span>types<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n    <span class=\\\"token keyword\\\">return</span> <span class=\\\"token function\\\">next</span><span class=\\\"token punctuation\\\">(</span>action<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token punctuation\\\">}</span>\\n  <span class=\\\"token keyword\\\">const</span> <span class=\\\"token punctuation\\\">[</span>Success<span class=\\\"token punctuation\\\">,</span> Fail<span class=\\\"token punctuation\\\">,</span> Request<span class=\\\"token punctuation\\\">]</span> <span class=\\\"token operator\\\">=</span> action<span class=\\\"token punctuation\\\">.</span>types<span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token keyword\\\">const</span> options <span class=\\\"token operator\\\">=</span> action<span class=\\\"token punctuation\\\">.</span>options<span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token function\\\">next</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">{</span>\\n    type<span class=\\\"token punctuation\\\">:</span> Request<span class=\\\"token punctuation\\\">,</span>\\n  <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token keyword\\\">return</span> <span class=\\\"token keyword\\\">new</span> <span class=\\\"token class-name\\\">Promise</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">(</span>resolve<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n    <span class=\\\"token function\\\">fetch</span><span class=\\\"token punctuation\\\">(</span>options<span class=\\\"token punctuation\\\">.</span>url<span class=\\\"token punctuation\\\">,</span> options<span class=\\\"token punctuation\\\">.</span>config<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">then</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token keyword\\\">async</span> <span class=\\\"token punctuation\\\">(</span>response<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n      <span class=\\\"token keyword\\\">let</span> json<span class=\\\"token punctuation\\\">;</span>\\n      <span class=\\\"token keyword\\\">if</span> <span class=\\\"token punctuation\\\">(</span>response<span class=\\\"token punctuation\\\">.</span>status <span class=\\\"token operator\\\">!==</span> <span class=\\\"token number\\\">204</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n        json <span class=\\\"token operator\\\">=</span> <span class=\\\"token keyword\\\">await</span> response<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">json</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n      <span class=\\\"token punctuation\\\">}</span>\\n      <span class=\\\"token keyword\\\">if</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token operator\\\">!</span>options<span class=\\\"token punctuation\\\">.</span>responseCode<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">includes</span><span class=\\\"token punctuation\\\">(</span>response<span class=\\\"token punctuation\\\">.</span>status<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n        <span class=\\\"token keyword\\\">throw</span> json<span class=\\\"token punctuation\\\">;</span>\\n      <span class=\\\"token punctuation\\\">}</span>\\n      <span class=\\\"token keyword\\\">if</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token keyword\\\">typeof</span> options<span class=\\\"token punctuation\\\">.</span>onSuccess <span class=\\\"token operator\\\">===</span> <span class=\\\"token string\\\">'function'</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n        options<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">onSuccess</span><span class=\\\"token punctuation\\\">(</span>json<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n      <span class=\\\"token punctuation\\\">}</span>\\n      <span class=\\\"token function\\\">next</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">{</span>\\n        type<span class=\\\"token punctuation\\\">:</span> Success<span class=\\\"token punctuation\\\">,</span>\\n        data<span class=\\\"token punctuation\\\">:</span> json<span class=\\\"token punctuation\\\">,</span>\\n      <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n      <span class=\\\"token function\\\">resolve</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token boolean\\\">true</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n    <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">.</span><span class=\\\"token keyword\\\">catch</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">(</span>e<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n      <span class=\\\"token keyword\\\">switch</span><span class=\\\"token punctuation\\\">(</span>e<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n        <span class=\\\"token keyword\\\">case</span> <span class=\\\"token string\\\">'token失效'</span><span class=\\\"token punctuation\\\">:</span>\\n        \\b<span class=\\\"token keyword\\\">case</span> <span class=\\\"token string\\\">'api error'</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token operator\\\">...</span>\\n      <span class=\\\"token punctuation\\\">}</span>\\n      <span class=\\\"token function\\\">resolve</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token boolean\\\">false</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n      <span class=\\\"token function\\\">next</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">{</span>\\n        type<span class=\\\"token punctuation\\\">:</span> Fail<span class=\\\"token punctuation\\\">,</span>\\n        error<span class=\\\"token punctuation\\\">:</span> e<span class=\\\"token punctuation\\\">,</span>\\n      <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n    <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n\\n\\n<span class=\\\"token comment\\\">//action</span>\\n<span class=\\\"token keyword\\\">export</span> <span class=\\\"token keyword\\\">const</span> <span class=\\\"token function-variable function\\\">action</span> <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">{</span>\\n  types<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">[</span>fetchSuccess<span class=\\\"token punctuation\\\">,</span> fetchError<span class=\\\"token punctuation\\\">,</span> fetching<span class=\\\"token punctuation\\\">]</span><span class=\\\"token punctuation\\\">,</span>\\n  options<span class=\\\"token punctuation\\\">:</span> <span class=\\\"token punctuation\\\">{</span>\\n    url<span class=\\\"token punctuation\\\">:</span> apiURL<span class=\\\"token punctuation\\\">,</span>\\n    config<span class=\\\"token punctuation\\\">:</span> <span class=\\\"token punctuation\\\">{</span>\\n      method<span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">'GET'</span><span class=\\\"token punctuation\\\">,</span>\\n      <span class=\\\"token operator\\\">...</span>\\n    <span class=\\\"token punctuation\\\">}</span>\\n  <span class=\\\"token punctuation\\\">}</span>\\n\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span></code></pre>\\n      </div>\\n<p>相信大部份人學習redux要處理非同步一定都聽過redux-thunk，短短的14行code拿下了6000+的星星。</p>\\n<p>這些都算是middleware的基礎，進階的應用也有chain promise(redux saga,redux observable)或是串web socket，middleware的概念很有趣，實作起來並不能難，能做的事情卻很多，建議一定要學一下。</p>\",\"fields\":{\"slug\":\"/posts/redux-middleware/\"},\"frontmatter\":{\"title\":\"Redux Middleware應用\",\"date\":\"2017-08-14T00:04\",\"tags\":[\"react\",\"redux\"]}}},\"pathContext\":{\"slug\":\"/posts/redux-middleware/\"}}\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./~/json-loader!./.cache/json/posts-redux-middleware.json\n// module id = 476\n// module chunks = 257634389667650"],"sourceRoot":""}